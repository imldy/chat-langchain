<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>与问答型虚拟人聊天</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="static/css/tailwind.min.css" rel="stylesheet">
    <style>
        .chat-body {
            width: 550px;
            margin: 50px auto;
        }
        .card-body {
            background-color: #333;
            color: #fff;
            border-radius: 10px;
        }
        .server-message {
            background-color: #444;
            padding: 10px;
            margin: 10px;
            border-radius: 10px;
        }
        .client-message {
            background-color: #555;
            padding: 10px;
            margin: 10px;
            border-radius: 10px;
        }
        .form-inline {
            display: flex;
            justify-content: space-between;
        }
        .form-control {
            width: 80%;
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px;
            margin-right: 10px;
        }
        #send {
            background-color: #4C4CFF;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
        }
        .form-message {
          margin-top: 10px;
        }
    </style>

</head>
<body class="bg-black">
    <div class="chat-body card">
        <div class="card-body p-5">
            <h4 class="card-title text-center text-xl font-medium"> 与问答型虚拟人聊天 </h4>
            <p class="card-text text-center text-sm" id="header"> 与 Ta 交流吧 </p>
            <hr class="border-gray-500 mb-5" style="margin-top: 20px;">
            <div id="messages" class="overflow-auto" style="max-height: 500px;">
            </div>
            <form action="" class="form-inline mt-5" id="chat-form" onsubmit="sendMessage(event)">
                <input type="text" class="form-control" placeholder="你有什么想说的？" id="messageText">
                <button id="send" type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <script>
        // 获取元素
        const messages = document.getElementById('messages');
        const header = document.getElementById('header');
        const MESSAGE_TEXT = document.getElementById('messageText');
        const SEND_BUTTON = document.getElementById('send');

        // 创建 WebSocket，主机地址根据当前用户访问地址获取
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const host = window.location.host;
        const path = "/chat";
        const ws = new WebSocket(`${protocol}//${host}${path}`);

        // WebSocket 接收消息
        ws.onmessage = function (event) {
            const data = JSON.parse(event.data);

            // 发送者为虚拟人
            if (data.sender === "bot") {
                switch (data.type) {
                    case "start":
                        header.innerHTML = "虚拟人思考中...";
                        messages.appendChild(createMessage("虚拟人", ""));
                        break;
                    case "stream":
                        header.innerHTML = "虚拟人说话中...";
                        appendToLastMessage(data.message);
                        break;
                    case "end":
                        header.innerHTML = "与 Ta 交流吧";
                        // 修改为可发送的
                        updateSendButton("sendable")
                        break;
                    case "info":
                        header.innerHTML = data.message;
                        break;
                    case "error":
                        header.innerHTML = "与 Ta 交流吧";
                        appendToLastMessage(data.message);
                        // 修改为可发送的
                        updateSendButton("sendable")
                        break;
                }

            } else { // 发送者为用户
                messages.appendChild(createMessage("你", data.message));
            }

            // 滚动到聊天记录底部
            messages.scrollTop = messages.scrollHeight;
        };

        // 创建消息元素
        function createMessage(sender, message) {
            const div = document.createElement('div');
            div.className = sender === "bot" ? 'server-message' : 'client-message';
            const p = document.createElement('p');
            p.innerHTML = `<strong>${sender}: </strong>${message}`;
            div.appendChild(p);
            return div;
        }

        // 在最后一条消息后追加新消息
        function appendToLastMessage(message) {
            const p = messages.lastElementChild.lastElementChild;
            if (message === "\n") {
                p.innerHTML += "<br>";
            } else {
                p.innerHTML += message;
            }
        }

        // 封装修改按钮状态的方法，根据传入参数修改发送按钮状态
        function updateSendButton(status) {
            if (status === 'thinking') {
                SEND_BUTTON.innerHTML = "思考中";
                SEND_BUTTON.disabled = true;
            } else if (status === 'sending') {
                SEND_BUTTON.innerHTML = "发送中";
                SEND_BUTTON.disabled = true;
            } else if (status === 'sendable') {
                SEND_BUTTON.innerHTML = "发送";
                SEND_BUTTON.disabled = false;
            } else {
                console.error('Invalid status');
            }
        }
        // 发送消息事件
        function sendMessage(event) {
            event.preventDefault();
            const message = MESSAGE_TEXT.value.trim();
            if (!message) {
                return;
            }

            // 发送消息给服务端
            ws.send(message);

            // 修改按钮为思考中
            updateSendButton("thinking")

            // 清空输入框
            MESSAGE_TEXT.value = "";
        }

        // 添加发送消息事件监听
        SEND_BUTTON.addEventListener('click', sendMessage);
        MESSAGE_TEXT.addEventListener('keydown', function (event) {
            if (event.key === "Enter") {
                sendMessage(event);
            }
        });
    </script>
</body>
</html>